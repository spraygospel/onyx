# Development Plan: LLM Selection Button Fix (Test-Driven Development)

## Problem Statement

The LLM selection button in the chat interface has critical issues:
1. **Not functional**: Button click doesn't trigger the popover to show available LLM options
2. **Wrong positioning**: Popover opens downward (default), but should open upward since button is at bottom of screen
3. **Missing provider display**: Must show LLM model names with their providers (OpenAI, Anthropic, Groq, etc.)
4. **Selection not working**: Selected LLM must be actually used when user starts chatting

## Development Methodology: Test-Driven Development (TDD)

**TDD Process:**
1. ðŸ”´ **Red**: Write failing tests first (defining expected behavior)
2. ðŸŸ¢ **Green**: Write minimal code to make tests pass
3. ðŸ”µ **Refactor**: Improve code while keeping tests green
4. âœ… **Validate**: Run comprehensive test suite to ensure functionality

## Current Architecture Analysis

### Component Structure
```
ChatInputBar.tsx (line 849-854)
â”œâ”€â”€ LLMPopover
    â”œâ”€â”€ PopoverTrigger (asChild)
    â”‚   â””â”€â”€ ChatInputOption (renders button)
    â””â”€â”€ PopoverContent (align="start")
        â””â”€â”€ List of available LLMs
```

### Data Flow
1. **LLM Providers**: Fetched via `useChatContext()` from `ChatContext.tsx`
2. **LLM Manager**: Manages current LLM selection and state via `useLlmManager()` hook
3. **Current LLM**: Stored in `llmManager.currentLlm` object
4. **Available Options**: Generated from `llmProviders.model_configurations` array

### Key Files Identified
- `web/src/app/chat/input/LLMPopover.tsx` - Main popover component
- `web/src/app/chat/input/ChatInputOption.tsx` - Button wrapper component
- `web/src/app/chat/input/ChatInputBar.tsx` - Parent container (line 849)
- `web/src/components/context/ChatContext.tsx` - Data provider
- `web/src/lib/hooks.ts` - LlmManager interface and implementation

## Root Cause Analysis

### Issue 1: Button Not Clicking
**Potential Causes:**
- `onClick` handler missing in `ChatInputOption` component
- State management issue with `isOpen` boolean
- Event propagation being blocked
- `asChild` prop not properly forwarding events

**Current State Investigation:**
- `LLMPopover` uses `useState(false)` for `isOpen` state
- `PopoverTrigger` uses `asChild` to delegate to `ChatInputOption`
- `ChatInputOption` has its own `onClick` handler that might conflict

### Issue 2: Wrong Popover Position
**Current Configuration:**
```typescript
<PopoverContent
  align="start"  // Opens aligned to start of trigger
  className="..."
>
```

**Required Configuration:**
- Need `side="top"` prop to open upward
- Possibly adjust `align` prop for better positioning

## Test-Driven Development Implementation Plan

### Phase 1: ðŸ”´ RED - Write Failing Tests First

#### 1.1 Unit Tests (React Testing Library + Jest)
**File**: `web/src/app/chat/input/__tests__/LLMPopover.test.tsx`

**Test Categories:**
```typescript
describe('LLMPopover Component', () => {
  describe('Button Click Functionality', () => {
    test('opens popover when button is clicked')
    test('closes popover when clicking outside')
    test('toggles popover state on multiple clicks')
  });

  describe('LLM Provider Display', () => {
    test('displays all available LLM providers')
    test('shows model names with provider labels')
    test('displays provider icons correctly')
    test('highlights currently selected model')
  });

  describe('Popover Positioning', () => {
    test('opens upward when positioned at bottom')
    test('positions correctly relative to trigger button')
    test('maintains proper spacing from trigger')
  });

  describe('LLM Selection', () => {
    test('updates llmManager when model is selected')
    test('closes popover after selection')
    test('persists selection across renders')
  });
});
```

#### 1.2 E2E Tests (Playwright)
**File**: `web/tests/e2e/llm-selection.spec.ts`

**Test Scenarios:**
```typescript
describe('LLM Selection E2E Tests', () => {
  test('User can open LLM selection popover')
  test('User sees all configured LLM providers')
  test('User can select different LLM model')
  test('Selected LLM is used in chat conversation')
  test('Popover opens upward near bottom of screen')
});
```

#### 1.3 Integration Tests
**File**: `web/src/app/chat/input/__tests__/ChatInputBar.integration.test.tsx`

**Integration Scenarios:**
```typescript
describe('Chat Input Bar Integration', () => {
  test('LLM selection integrates with chat context')
  test('Selected model persists during chat session')
  test('Model switch updates conversation context')
});
```

### Phase 2: ðŸŸ¢ GREEN - Implement Minimal Working Solution

#### 2.1 Fix Button Click Event Handling
**Target**: Make popover open/close on button click
- Investigate `asChild` prop with `PopoverTrigger`
- Fix event handling conflicts in `ChatInputOption`
- Ensure proper state management for `isOpen`

#### 2.2 Fix Popover Positioning
**Target**: Make popover open upward
```typescript
<PopoverContent
  side="top"
  align="center"
  sideOffset={8}
  className="..."
>
```

#### 2.3 Display Provider Information
**Target**: Show model names with provider labels
- Format display: `{modelName} (via {providerName})`
- Ensure provider icons are visible
- Highlight currently selected model

#### 2.4 Implement LLM Selection Logic
**Target**: Actually switch LLM when user clicks option
- Call `llmManager.updateCurrentLlm()` on selection
- Verify selection persists in chat context
- Close popover after successful selection

### Phase 3: ðŸ”µ REFACTOR - Improve Code Quality

#### 3.1 Code Organization
- Extract reusable components
- Improve TypeScript types
- Add proper error handling
- Optimize re-rendering performance

#### 3.2 User Experience Polish
- Add loading states during model switching
- Improve visual feedback
- Add smooth animations
- Enhance accessibility

### Phase 4: âœ… VALIDATE - Comprehensive Testing

#### 4.1 Run All Test Suites
```bash
# Unit tests
npm test LLMPopover

# E2E tests
npm run test:e2e -- llm-selection

# Integration tests  
npm test ChatInputBar.integration
```

#### 4.2 Manual Testing Checklist
- [ ] Button click opens popover âœ…
- [ ] Popover shows all LLM providers âœ…  
- [ ] Provider names and icons display correctly âœ…
- [ ] Popover opens upward near bottom âœ…
- [ ] Model selection actually switches LLM âœ…
- [ ] Selected model is used in chat âœ…
- [ ] Keyboard navigation works âœ…
- [ ] Mobile responsive âœ…

## Test Implementation Strategy

### Pre-Implementation: Test Setup

#### Create Test Infrastructure
**File Structure:**
```
web/src/app/chat/input/__tests__/
â”œâ”€â”€ LLMPopover.test.tsx          # Unit tests
â”œâ”€â”€ ChatInputBar.integration.test.tsx  # Integration tests
â””â”€â”€ __mocks__/
    â”œâ”€â”€ mockLlmProviders.ts      # Mock LLM provider data
    â””â”€â”€ mockLlmManager.ts        # Mock LLM manager

web/tests/e2e/
â”œâ”€â”€ llm-selection.spec.ts        # E2E tests
â””â”€â”€ fixtures/
    â””â”€â”€ llm-test-data.json       # Test data fixtures
```

#### Test Data Setup
**Mock LLM Providers:**
```typescript
export const mockLlmProviders: LLMProviderDescriptor[] = [
  {
    name: "OpenAI",
    provider: "openai",
    model_configurations: [
      { name: "gpt-4", is_visible: true },
      { name: "gpt-3.5-turbo", is_visible: true }
    ]
  },
  {
    name: "Anthropic", 
    provider: "anthropic",
    model_configurations: [
      { name: "claude-3-haiku", is_visible: true },
      { name: "claude-3-sonnet", is_visible: true }
    ]
  },
  {
    name: "Groq",
    provider: "groq", 
    model_configurations: [
      { name: "llama-3.3-70b-versatile", is_visible: true }
    ]
  }
];
```

### Implementation Tasks (TDD Order)

#### Task 1: ðŸ”´ Write Failing Unit Tests
- [ ] Create `LLMPopover.test.tsx` with failing tests
- [ ] Setup test environment with mock providers
- [ ] Define expected behavior in test cases
- [ ] Verify all tests fail initially

#### Task 2: ðŸŸ¢ Fix Button Click (Make Tests Pass)
- [ ] Debug and fix event handling in `ChatInputOption`
- [ ] Ensure `PopoverTrigger` receives click events
- [ ] Fix `isOpen` state management
- [ ] Run tests until click tests pass

#### Task 3: ðŸŸ¢ Fix Popover Positioning (Make Tests Pass)
- [ ] Add `side="top"` to `PopoverContent`
- [ ] Test positioning behavior
- [ ] Run tests until positioning tests pass

#### Task 4: ðŸŸ¢ Implement Provider Display (Make Tests Pass)
- [ ] Format model names with provider info
- [ ] Show provider icons
- [ ] Highlight selected model
- [ ] Run tests until display tests pass

#### Task 5: ðŸŸ¢ Implement LLM Selection (Make Tests Pass)
- [ ] Wire up `llmManager.updateCurrentLlm()`
- [ ] Close popover after selection
- [ ] Persist selection state
- [ ] Run tests until selection tests pass

#### Task 6: ðŸ”´ðŸŸ¢ Write and Pass E2E Tests
- [ ] Create Playwright E2E tests
- [ ] Test full user journey
- [ ] Verify chat integration
- [ ] Make E2E tests pass

#### Task 7: ðŸ”µ Refactor and Polish
- [ ] Improve code organization
- [ ] Add error handling
- [ ] Optimize performance
- [ ] Keep all tests green during refactoring

#### Task 8: âœ… Final Validation
- [ ] Run complete test suite
- [ ] Manual testing across scenarios
- [ ] Performance validation
- [ ] Accessibility audit

## TDD Acceptance Criteria

### ðŸ”´ RED Phase - Test Requirements
1. **Unit Tests Must Fail Initially**
   - [ ] Button click test fails (popover doesn't open)
   - [ ] Provider display test fails (providers not shown)
   - [ ] Positioning test fails (opens downward)
   - [ ] Selection test fails (LLM not switched)

2. **E2E Tests Must Fail Initially** 
   - [ ] Full user journey test fails
   - [ ] Chat integration test fails
   - [ ] Provider visibility test fails

### ðŸŸ¢ GREEN Phase - Functional Requirements
1. **Button Click Functionality**
   - âœ… Button click opens LLM selection popover
   - âœ… Popover closes when clicking outside
   - âœ… Multiple clicks toggle popover state correctly

2. **LLM Provider Display**
   - âœ… Popover displays all available LLM models
   - âœ… Models show with provider name: `"Model Name (via Provider)"`
   - âœ… Provider icons display correctly (OpenAI, Anthropic, Groq, etc.)
   - âœ… Current selected model is highlighted/distinguished

3. **Popover Positioning**
   - âœ… Popover opens **upward** when button is near bottom
   - âœ… Proper spacing between button and popover (8px offset)
   - âœ… Center-aligned with trigger button

4. **LLM Selection Functionality**
   - âœ… Clicking model calls `llmManager.updateCurrentLlm()`
   - âœ… Selected LLM is actually used when user starts chatting
   - âœ… Popover closes after selection
   - âœ… Selection persists across chat sessions

### ðŸ”µ REFACTOR Phase - Quality Requirements
1. **Code Quality**
   - âœ… No console errors or warnings
   - âœ… Proper TypeScript types
   - âœ… Clean component structure
   - âœ… Optimized re-rendering performance

2. **User Experience**
   - âœ… Smooth open/close animations
   - âœ… Clear visual feedback during selection
   - âœ… Loading states where appropriate
   - âœ… Responsive design works on mobile

3. **Accessibility**
   - âœ… Keyboard navigation support
   - âœ… Screen reader compatible
   - âœ… Proper ARIA labels
   - âœ… Focus management

### âœ… VALIDATE Phase - Integration Requirements
1. **Test Suite Passes**
   - âœ… All unit tests pass (100% success rate)
   - âœ… All E2E tests pass (user journey complete)
   - âœ… All integration tests pass (chat context integration)

2. **Real-World Validation**
   - âœ… Manual testing across different browsers
   - âœ… Mobile device testing
   - âœ… Multiple LLM provider scenarios
   - âœ… Chat conversation uses selected model

3. **Performance Criteria**
   - âœ… Popover opens within 100ms of click
   - âœ… Model switching completes within 200ms
   - âœ… No memory leaks during repeated operations
   - âœ… Accessibility audit score >90%

## Risk Assessment

### Low Risk
- Popover positioning fix (simple prop change)
- Visual styling improvements

### Medium Risk
- Event handling conflicts between components
- State management issues with `asChild` pattern

### High Risk
- Breaking existing LLM switching functionality
- Unintended side effects on other popover components

## TDD Testing Strategy

### Phase 1: Unit Tests (React Testing Library + Jest)

#### Test Setup Requirements
```typescript
// Mock implementations needed
import { mockLlmProviders } from './__mocks__/mockLlmProviders';
import { mockLlmManager } from './__mocks__/mockLlmManager';
```

#### Critical Unit Tests
1. **Button Click Tests**
   ```typescript
   test('opens popover when button is clicked', async () => {
     const user = userEvent.setup();
     render(<LLMPopover {...mockProps} />);
     
     const trigger = screen.getByTestId('llm-popover-trigger');
     await user.click(trigger);
     
     expect(screen.getByRole('dialog')).toBeInTheDocument();
   });
   ```

2. **Provider Display Tests**
   ```typescript
   test('displays all available LLM providers with names', () => {
     render(<LLMPopover llmProviders={mockLlmProviders} {...otherProps} />);
     
     const trigger = screen.getByTestId('llm-popover-trigger');
     fireEvent.click(trigger);
     
     expect(screen.getByText(/gpt-4 \(via OpenAI\)/)).toBeInTheDocument();
     expect(screen.getByText(/claude-3-haiku \(via Anthropic\)/)).toBeInTheDocument();
     expect(screen.getByText(/llama-3.3-70b-versatile \(via Groq\)/)).toBeInTheDocument();
   });
   ```

3. **Selection Tests**
   ```typescript
   test('calls llmManager.updateCurrentLlm when model is selected', async () => {
     const mockUpdateLlm = jest.fn();
     const mockLlmManager = { ...baseMockLlmManager, updateCurrentLlm: mockUpdateLlm };
     
     render(<LLMPopover llmManager={mockLlmManager} {...otherProps} />);
     
     // Open popover and click model
     await user.click(screen.getByTestId('llm-popover-trigger'));
     await user.click(screen.getByText(/gpt-4/));
     
     expect(mockUpdateLlm).toHaveBeenCalledWith({
       name: "OpenAI",
       provider: "openai", 
       modelName: "gpt-4"
     });
   });
   ```

### Phase 2: E2E Tests (Playwright MCP)

#### E2E Test Implementation
**File**: `web/tests/e2e/llm-selection.spec.ts`

```typescript
import { test, expect } from '@playwright/test';

test.describe('LLM Selection E2E', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/chat');
    // Wait for chat interface to load
    await page.waitForSelector('[data-testid="chat-input"]');
  });

  test('User can open and use LLM selection popover', async ({ page }) => {
    // 1. Click LLM selection button
    await page.click('[data-testid="llm-popover-trigger"]');
    
    // 2. Verify popover opens upward
    const popover = page.locator('[role="dialog"]');
    await expect(popover).toBeVisible();
    
    // Check positioning (should be above trigger)
    const triggerBox = await page.locator('[data-testid="llm-popover-trigger"]').boundingBox();
    const popoverBox = await popover.boundingBox();
    expect(popoverBox!.y + popoverBox!.height).toBeLessThan(triggerBox!.y);
    
    // 3. Verify providers are shown with correct format
    await expect(page.locator('text=/.*\(via .+\)/')).toHaveCount.greaterThan(0);
    
    // 4. Select different model
    await page.click('text=/gpt-4 \(via OpenAI\)/');
    
    // 5. Verify popover closes
    await expect(popover).not.toBeVisible();
    
    // 6. Verify model selection persists (check button text)
    await expect(page.locator('[data-testid="llm-popover-trigger"]')).toContainText('gpt-4');
  });

  test('Selected LLM is used in chat conversation', async ({ page }) => {
    // Select specific model
    await page.click('[data-testid="llm-popover-trigger"]');
    await page.click('text=/claude-3-haiku \(via Anthropic\)/');
    
    // Send a test message
    await page.fill('[data-testid="chat-input"]', 'Hello, what model are you?');
    await page.click('[data-testid="send-button"]');
    
    // Verify response indicates correct model
    // (This would need backend support to echo model info)
    await expect(page.locator('[data-testid="chat-message"]')).toBeVisible();
  });
});
```

### Phase 3: Integration Tests

#### Integration Test Focus
```typescript
test.describe('Chat Input Bar Integration', () => {
  test('LLM selection integrates with chat context', () => {
    // Test that LLMPopover receives correct props from ChatContext
    // Test that model changes propagate through context
    // Test that selection persists across component re-renders
  });
});
```

### TDD Test Execution Order

1. **ðŸ”´ RED: Write failing tests first**
   ```bash
   cd web
   npm test LLMPopover.test.tsx  # Should fail initially
   ```

2. **ðŸŸ¢ GREEN: Make tests pass incrementally**
   ```bash
   # After each implementation step
   npm test LLMPopover.test.tsx  # Verify specific tests pass
   ```

3. **ðŸ”µ REFACTOR: Keep tests green during refactoring**
   ```bash
   npm test LLMPopover.test.tsx  # Ensure no regressions
   ```

4. **âœ… VALIDATE: Run comprehensive test suite**
   ```bash
   # Unit tests
   npm test LLMPopover
   
   # E2E tests  
   npm run test:e2e -- llm-selection
   
   # Full test suite
   npm test
   ```

## Success Metrics

1. **Functionality**: 100% success rate for popover opening on click
2. **Positioning**: Popover opens upward when button is in bottom 30% of viewport
3. **Performance**: No significant rendering delays (<100ms)
4. **Accessibility**: WCAG 2.1 AA compliance for popover interaction

## Implementation Order

1. **Debug Phase**: Identify root cause of click issue
2. **Quick Fix**: Apply minimal changes to restore functionality
3. **Positioning Fix**: Update popover positioning props
4. **Polish Phase**: Improve UX and accessibility
5. **Testing Phase**: Comprehensive validation across scenarios

## Dependencies

- âœ… Radix UI Popover component documentation
- âœ… Existing LLM provider configuration system
- âœ… Chat context state management
- âœ… Current LLM manager implementation

---

**Priority**: HIGH (user-facing functionality broken)
**Effort**: MEDIUM (debugging + positioning fixes)
**Impact**: HIGH (core chat interface feature)